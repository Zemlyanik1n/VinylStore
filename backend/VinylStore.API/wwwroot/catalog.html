<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Каталог виниловых пластинок</title>
  <link rel="stylesheet" href="styles/catalog.css">
</head>
<body>
<header>
  <div class="logo">Виниловый Магазин</div>
  <nav>
    <ul>
      <li><a href="index.html">Главная</a></li>
      <li><a href="catalog.html" class="active">Каталог</a></li>
      <li><a href="cart.html">Корзина</a></li>
      <li><a href="care.html">Уход за винилом</a></li>
      <li><a href="add_vinyl.html">Добавить пластинку</a></li>
      <li><a href="about.html">О нас</a></li>
    </ul>
  </nav>
</header>

<main>
  <div class="catalog-container">
    <div class="main-content">
      <div class="vinyl-grid" id="vinyl-grid"></div>
      <div class="load-more-container">
        <button class="load-more-btn" id="loadMore" onclick="loadMore()">Загрузить еще</button>
      </div>
    </div>

    <aside class="filters-sidebar">
      <h2>Фильтры</h2>
      <div class="filter-group">
        <input type="text" id="search" placeholder="Поиск...">
      </div>
      <div class="filter-group">
        <select id="genre">
          <option value="">Все жанры</option>
        </select>
      </div>
      <div class="filter-group">
        <input type="number" id="minPrice" placeholder="Цена от" min="0" step="1">
        <input type="number" id="maxPrice" placeholder="Цена до" min="0" step="1">
      </div>
      <div class="filter-group">
        <input type="number" id="year" placeholder="Год релиза" min="1600" max="2025" step="1">
      </div>
      <div class="filter-group">
        <select id="releaseType">
          <option value="">Все типы</option>
          <option value="LP">LP</option>
          <option value="EP">EP</option>
          <option value="Single">Сингл</option>
        </select>
      </div>
      <div class="filter-group">
        <select id="sortBy">
          <option value="year_desc">Новые сначала</option>
          <option value="year_asc">Старые сначала</option>
          <option value="price_asc">Дешевые сначала</option>
          <option value="price_desc">Дорогие сначала</option>
        </select>
      </div>
      <button class="apply-btn" onclick="loadData(true)">Применить</button>
    </aside>
  </div>
</main>

<footer>
  <p>&copy; 2025 Виниловый Магазин. Все права защищены.</p>
</footer>

<script>
  let currentPage = 1;
  let isLoading = false;
  let hasMore = true;

  async function loadData(reset = false) {
    if (!navigator.onLine) {
      alert('Нет интернет-соединения. Проверьте подключение к сети.');
      return;
    }
    if (isLoading) {
      console.log('Запрос уже выполняется');
      return;
    }
    if (!validateFilters()) return;
    try {
      isLoading = true;
      document.getElementById('loadMore').disabled = true;

      if (reset) {
        currentPage = 1;
        hasMore = true;
        document.getElementById('vinyl-grid').innerHTML = '';
      }

      const pageSize = 8;
      const params = new URLSearchParams({
        page: currentPage,
        pageSize,
        search: document.getElementById('search').value.toLowerCase().trim(),
        genre: document.getElementById('genre').value,
        minPrice: document.getElementById('minPrice').value,
        maxPrice: document.getElementById('maxPrice').value,
        releaseYear: document.getElementById('year').value,
        releaseType: document.getElementById('releaseType').value,
        sortBy: document.getElementById('sortBy').value || 'price_desc'
      });

      const response = await fetch(`/api/vinyls?${params}`);
      if (!response.ok) throw new Error('Ошибка загрузки');

      const data = await response.json();
      hasMore = data.page < data.totalPages;

      renderVinyls(data.items, reset);
      currentPage++;

    } catch (error) {
      console.error('Ошибка:', error);
      alert('Не удалось загрузить данные');
    } finally {
      isLoading = false;
      document.getElementById('loadMore').disabled = !hasMore;
    }
  }

  function validateNumberInput(value, min, max) {
    const num = parseFloat(value);
    return !isNaN(num) && num >= min && num <= max;
  }

  function validateFilters() {
    const minPrice = document.getElementById('minPrice').value;
    const maxPrice = document.getElementById('maxPrice').value;
    const year = document.getElementById('year').value;

    // Проверка цены
    if (minPrice && !validateNumberInput(minPrice, 0, Infinity)) {
      alert('Минимальная цена должна быть числом больше или равным 0');
      return false;
    }

    if (maxPrice && !validateNumberInput(maxPrice, 0, Infinity)) {
      alert('Максимальная цена должна быть числом больше или равным 0');
      return false;
    }

    if (minPrice && maxPrice && parseFloat(minPrice) > parseFloat(maxPrice)) {
      alert('Минимальная цена не может быть больше максимальной');
      return false;
    }

    // Проверка года (если поле не пустое)
    if (year && !validateNumberInput(year, 1700, new Date().getFullYear())) {
      alert(`Год должен быть числом от 1700 до ${new Date().getFullYear()}`);
      return false;
    }

    return true;
  }

  function restrictToNumbers(inputElement) {
    inputElement.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
  }

  function enforceMinMax(inputElement, min, max) {
    inputElement.addEventListener('change', (e) => {
      let value = e.target.value.trim();
      if (value === '') return; // Если поле пустое, ничего не делаем

      value = parseFloat(value);
      if (isNaN(value)) value = min;
      if (value < min) value = min;
      if (value > max) value = max;
      e.target.value = value;
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    restrictToNumbers(document.getElementById('minPrice'));
    restrictToNumbers(document.getElementById('maxPrice'));
    restrictToNumbers(document.getElementById('year'));

    enforceMinMax(document.getElementById('minPrice'), 0, Infinity);
    enforceMinMax(document.getElementById('maxPrice'), 0, Infinity);
    enforceMinMax(document.getElementById('year'), 1700, new Date().getFullYear());
  });

  function renderVinyls(items, reset) {
    const grid = document.getElementById('vinyl-grid');
    if (reset) grid.innerHTML = '';

    if (items.length === 0) {
      grid.innerHTML = '<p class="no-results">Ничего не найдено. Попробуйте изменить фильтры.</p>';
      return;
    }

    grid.insertAdjacentHTML('beforeend', items.map(item => `
    <div class="vinyl-card">
      <img src="${item.coverUrl}" alt="${item.albumName}" onerror="this.src='default-image.jpg'">
      <div class="vinyl-info">
        <h3>${item.albumName}</h3>
        <p>${item.artistName}</p>
        <p>${item.releaseYear} • ${item.releaseType}</p>
        <p>Состояние: ${item.condition}</p>
        <p>Год печати: ${item.printYear}</p>
        <p>Жанры: ${item.genres?.join(', ') || 'Не указано'}</p>
        <p class="price">${item.price.toFixed(2)} ₽</p>
        <a href="/vinyl/${item.vinylPlateId}" class="details-btn">Подробнее</a>
      </div>
    </div>
  `).join(''));
  }

  function loadMore() {
    if (hasMore && !isLoading) {
      loadData();
    }
  }
  

  async function loadGenres() {
    try {
      const response = await fetch('/api/vinyls/genres');
      const genres = await response.json();
      const select = document.getElementById('genre');
      select.innerHTML = '<option value="">Все жанры</option>' +
              genres.map(g => `<option value="${g.name}">${g.name}</option>`).join('');
    } catch (error) {
      console.error('Ошибка загрузки жанров:', error);
    }
  }
  
  // Инициализация
  document.addEventListener('DOMContentLoaded', () => {
    loadData(true);
    loadGenres();
  });
</script>
</body>
</html>